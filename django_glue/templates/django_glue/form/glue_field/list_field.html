{% extends "django_glue/form/glue_field/base_field.html" %}

{% block field_content %}
    <div
        x-data="{
            glue_data: {{ glue_data|default:'{}' }},
            item: null,
            selected: Object.entries({{ glue_data.selected_choices|default:'{}' }}).map(([id, values]) => ({ id, ...values })),

            async init() {
                this.glue_field.hide_label();
            },

            async add_item() {
                let item = this.glue_field.value;
                let found = this.glue_field.choices.find(choice => choice[0] == item);

                if (item && found) {
                    let selection = this.glue_data.all_choices[item];

                    this.selected.push({
                        id: item,
                        ...selection
                    });

                    this.glue_field.choices = this.glue_field.choices.filter(choice => choice[0] != item);

                    if (this.glue_field.choices.length > 0) {
                        this.glue_field.value = this.glue_field.choices[0][0];
                    } else {
                        this.glue_field.value = '';
                    }
                }
            },

            async remove_item(index) {
                let removed = this.selected[index];
                this.selected.splice(index, 1);

                this.glue_field.value = '';

                let label = this.glue_data.display_label;

                this.glue_field.choices = [
                    ...this.glue_field.choices,
                    [removed.id, removed[label]]
                ];

                this.glue_field.value = removed.id;
            },

            submit() {
                let serialized = JSON.stringify(this.selected);
                this.$refs.list_component.value = serialized;
            },
        }",
        x-effect="submit()"
    >
        <div class="row g-2 mb-2">
            {% block component_field %}
                <div class="col-10">
                    {% include "django_glue/form/glue_field/search_and_select_field.html" with glue_field=glue_field %}
                </div>
            {% endblock %}

            {% block add_item_button %}
                <div class="col-2 d-flex align-items-stretch">
                    <button type="button" @click.prevent="add_item()" class="btn btn-primary w-100 h-100">Add</button>
                </div>
            {% endblock %}
        </div>

        <template x-if="selected.length === 0">
            <div class="mt-4 text-muted">
                No item(s) selected.
            </div>
        </template>

        <template x-for="(item, index) in selected" :key="item.id">
            <div class="row align-items-center item-hover item-container border-bottom border-300 py-2">
                {% block item_row_content %}
                {% endblock %}

                {% block remove_item_button %}
                {% endblock %}
            </div>
        </template>
    </div>
{% endblock %}
